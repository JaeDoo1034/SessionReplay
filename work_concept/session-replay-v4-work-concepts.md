# Session Replay v4 개발 개념 정리

이 문서는 v4 로직 개발 중 핵심이었던 개념을 정리합니다.
각 항목은 `무엇인지`와 `왜 이번 개발에 필요했는지`를 함께 설명합니다.

## 1) 이벤트 시퀀스 재생 (Event Sequence Replay)

### 무엇인지

사용자 클릭을 단일 `click` 이벤트 하나로만 처리하지 않고, 실제 브라우저 상호작용 흐름에 가까운 순서로 재생하는 방식입니다.

- 예: `pointerdown -> mousedown -> pointerup -> mouseup -> click`
- 입력도 값 대입만 하지 않고 `input/change` 이벤트를 디스패치

### 왜 필요했는지

탭 UI, 아코디언, 커스텀 버튼처럼 프레임워크 핸들러는 단순 스타일 변경보다 이벤트 체인을 기준으로 동작하는 경우가 많습니다.
기존처럼 “클릭 표시만” 하면 화면은 눌린 것처럼 보여도 실제 콘텐츠 전환이 일어나지 않았습니다.
그래서 실제 이벤트 시퀀스 재생이 필요했습니다.

## 2) Mutation ON/OFF 토글

### 무엇인지

리플레이 시 `mutation` 이벤트를 적용할지 여부를 런타임에서 전환하는 기능입니다.

- `ON`: 녹화 중 DOM 변화를 가능한 많이 따라감
- `OFF`: 스냅샷 + 인터랙션 중심으로 재생

### 왜 필요했는지

실서비스 페이지(포털/대형 SPA)는 실시간 광고, 지연 렌더링, 프레임워크 내부 갱신이 많아 mutation을 모두 재적용하면 오히려 레이아웃이 깨질 수 있습니다.
따라서 상황별로 안정성 우선(`OFF`) 또는 재현성 우선(`ON`)을 선택할 수 있어야 했습니다.

## 3) Viewport 스케일링

### 무엇인지

녹화 시점 viewport 크기와 재생 시점 viewport 크기가 다를 때, 녹화 기준 해상도를 유지한 채 축소/확대해서 재생하는 방식입니다.

- 녹화 viewport: `snapshot.data.viewport`
- 재생 stage 크기에 맞춰 iframe에 `scale` 적용

### 왜 필요했는지

녹화는 넓은 화면, 재생은 작은 모달에서 수행되면 CSS 배치와 포인터 좌표가 어긋납니다.
특히 절대 위치/반응형 브레이크포인트가 많은 페이지에서 화면이 깨져 보이거나 클릭 위치가 틀어집니다.
스케일링은 레이아웃 깨짐과 좌표 불일치를 동시에 줄이기 위해 필요했습니다.

## 4) Sandbox 해제 (Replay iframe)

### 무엇인지

리플레이 iframe의 `sandbox` 제한을 완화하거나 제거해, 스냅샷 내부 스크립트/동적 동작이 실행되도록 하는 설정입니다.

### 왜 필요했는지

일부 환경에서 `about:srcdoc ... allow-scripts` 관련 차단 오류가 발생했고, 차단 상태에서는 사이트 동적 로직이 정상 실행되지 않아 재현성이 크게 떨어졌습니다.
동작 재현을 우선해야 하는 디버깅/검증 목적에서는 sandbox 해제가 실질적으로 필요했습니다.

주의: 보안 격리 수준은 낮아지므로, 신뢰 가능한 페이지/내부 테스트 환경에서 사용해야 합니다.

## 5) 포인터 좌표 매핑 (절대 + 타겟 상대 보정)

### 무엇인지

클릭/마우스 이동 좌표를 재생 DOM에서 다시 계산하는 로직입니다.

- 기본: viewport 비율 기반 매핑
- 보정: 타겟 요소 크기/offset 기반 상대좌표 매핑

### 왜 필요했는지

단순 비율 스케일만으로는 세로축 오차, 요소 경계 오차가 발생할 수 있습니다.
특히 레이아웃이 유동적인 사이트에서는 요소 상대좌표를 함께 쓰는 것이 실제 클릭 위치 재현에 더 안정적이었습니다.

## 6) 네비게이션 이벤트 추적 (SPA 포함)

### 무엇인지

전통적인 페이지 이동뿐 아니라 SPA 라우팅까지 추적하는 방식입니다.

- `hashchange`, `popstate`, `visibilitychange`
- `history.pushState/replaceState` 패치
- 클릭 기반 `navigation_intent` 기록

### 왜 필요했는지

요즘 서비스는 전체 새로고침 없이 URL/뷰가 바뀝니다.
이 이동 흐름을 기록하지 않으면 세션 맥락(어느 화면에서 무엇을 했는지)이 끊기고 replay/분석 정확도가 떨어집니다.

## 7) 내부 UI 제외 (Recorder Ignore Node)

### 무엇인지

리플레이/분석 제어 UI 자체를 녹화 대상에서 제외하는 필터링입니다.

### 왜 필요했는지

도구 UI(패널, 모달, 버튼)가 함께 기록되면 원본 사용자 행동 데이터가 오염됩니다.
실제 사용자 행동만 남기기 위해 내부 노드 무시는 필수였습니다.

## 8) LLM 결과 정규화 (서버단)

### 무엇인지

LLM 응답이 흔들리더라도 프론트가 항상 동일 스키마를 받도록 서버에서 결과를 정규화하는 처리입니다.

### 왜 필요했는지

LLM은 프롬프트를 지켜도 형식이 불완전할 수 있습니다.
프론트 렌더링 안정성과 후속 체인 처리를 위해, `primary_type/secondary_types/confidence/evidence/recommendations` 및 한국어 최종 구조를 일관되게 보장할 필요가 있었습니다.

## 정리

v4의 핵심은 “보여주기용 재생”에서 “실제 동작 재현”으로 넘어간 것입니다.
이를 위해 이벤트 시퀀스 재생, mutation 토글, viewport 스케일링, sandbox 정책 조정이 함께 필요했습니다.
